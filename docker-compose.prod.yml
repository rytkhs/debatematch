services:
    app:
        build:
            context: .
            dockerfile: docker/prod/php/Dockerfile
            target: app
        restart: unless-stopped
        init: true
        env_file:
            - ./.env
        volumes:
            - public-data:/var/www/html/public
            - storage-data:/var/www/html/storage
        networks:
            - sail
        depends_on:
            redis:
                condition: service_healthy
            mysql:
                condition: service_healthy
        logging: &awslogs_app
            driver: 'awslogs'
            options:
                awslogs-region: '${AWS_REGION:-ap-northeast-1}'
                awslogs-group: '/docker/DebateMatch/app'
                awslogs-create-group: 'false'
                awslogs-multiline-pattern: '^\[[0-9]{4}-[0-9]{2}-[0-9]{2}'
                tag: '{{.Name}}-{{.ID}}'

    nginx:
        image: nginx:1.25-alpine
        restart: unless-stopped
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./docker/prod/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
            - /etc/letsencrypt:/etc/letsencrypt:ro
            - /home/ec2-user/app/data/certbot/www:/var/www/certbot
            - public-data:/var/www/html/public:ro
            - storage-data:/var/www/html/storage:ro
        networks:
            - sail
        depends_on:
            - app
        logging:
            driver: 'awslogs'
            options:
                awslogs-region: '${AWS_REGION:-ap-northeast-1}'
                awslogs-group: '/docker/DebateMatch/nginx'
                awslogs-create-group: 'false'
                tag: '{{.Name}}-{{.ID}}'

    worker:
        build:
            context: .
            dockerfile: docker/prod/php/Dockerfile
            target: worker
        restart: unless-stopped
        init: true
        env_file:
            - ./.env
        volumes:
            - storage-data:/var/www/html/storage
        networks:
            - sail
        depends_on:
            redis:
                condition: service_healthy
            mysql:
                condition: service_healthy
        logging:
            driver: 'awslogs'
            options:
                awslogs-region: '${AWS_REGION:-ap-northeast-1}'
                awslogs-group: '/docker/DebateMatch/worker'
                awslogs-create-group: 'false'
                awslogs-multiline-pattern: '^\[[0-9]{4}-[0-9]{2}-[0-9]{2}'
                tag: '{{.Name}}-{{.ID}}'

    redis:
        image: redis:7-alpine
        restart: unless-stopped
        env_file:
            - ./.env
        entrypoint: ['/usr/local/bin/redis-entrypoint.sh']
        volumes:
            - redis-data:/data
            - ./docker/prod/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
            - ./docker/prod/redis/entrypoint.sh:/usr/local/bin/redis-entrypoint.sh:ro
        networks:
            - sail
        healthcheck:
            test: ['CMD', 'redis-cli', '-a', '${REDIS_PASSWORD}', 'ping']
            interval: 10s
            timeout: 5s
            retries: 3

    mysql:
        image: mysql:8.4.5
        restart: unless-stopped
        env_file:
            - ./.env
        environment:
            TZ: Asia/Tokyo
        command:
            - --character-set-server=utf8mb4
            - --collation-server=utf8mb4_0900_ai_ci
            - --sql-mode=NO_ENGINE_SUBSTITUTION
            - --innodb_buffer_pool_size=256M
            - --max_connections=50
            - --table_open_cache=200
            - --performance_schema=OFF
        volumes:
            - /home/ec2-user/app/data/mysql:/var/lib/mysql
        networks:
            - sail
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'mysqladmin ping -h 127.0.0.1 -uroot -p$${MYSQL_ROOT_PASSWORD} --silent',
                ]
            interval: 10s
            timeout: 5s
            retries: 5
        ports:
            - '127.0.0.1:3306:3306'

networks:
    sail:
        driver: bridge

volumes:
    redis-data:
        name: debate_match_redis_data
        driver: local
    public-data:
        # ビルド成果物(public/build等)の共有専用
        name: debate_match_public_data
        driver: local
    storage-data:
        # storage 永続化（uploads/logs/cache等）
        name: debate_match_storage_data
        driver: local
